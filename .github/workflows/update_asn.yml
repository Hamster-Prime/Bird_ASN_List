name: Update ASN CIDR

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-asn:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Fetch CIDRs from bgp.he.net
      run: |
        # å®šä¹‰éœ€è¦å¤„ç†çš„ ASN åˆ—è¡¨
        asns=("AS396856" "AS51894" "AS32590" "AS44907" "AS62014" "AS59930" "AS62041" "AS211157")
        
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        mkdir -p ASN_CIDR
        
        # å¾ªçŽ¯è¿è¡Œè„šæœ¬
        for asn in "${asns[@]}"; do
          echo "Processing $asn..."
          # è¿è¡Œè„šæœ¬ï¼Œå¦‚æžœä¸æˆåŠŸä¸ç«‹å³é€€å‡ºï¼Œä½†ä¼šè®°å½•
          if python fetch_asn_cidr_he.py "$asn"; then
             echo "Successfully processed $asn"
          else
             echo "Failed to process $asn"
          fi
          
          # åœ¨è¯·æ±‚ä¹‹é—´æ·»åŠ é¢å¤–çš„éšæœºç­‰å¾…ï¼Œé™ä½Žè¢«å°å‡ çŽ‡
          sleep $((RANDOM % 10 + 5))
        done

    - name: Update README.md
      run: |
        UPDATE_TIME=$(date -u --iso-8601=seconds)
        > README.md
        echo "# å…¨çƒ ASN CIDR åˆ—è¡¨" >> README.md
        echo "" >> README.md
        echo "**è¯´æ˜Žï¼š** æ­¤æ•°æ®æ¯æ—¥ä»Ž [bgp.he.net](https://bgp.he.net/) è‡ªåŠ¨èŽ·å–ã€‚" >> README.md
        echo "" >> README.md
        echo "---" >> README.md
        echo "" >> README.md
        echo "## ðŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> README.md
        echo "" >> README.md
        echo "**æœ€åŽæ›´æ–°æ—¶é—´ï¼š** ${UPDATE_TIME}" >> README.md
        echo "" >> README.md
        TOTAL_FILES=$(find ASN_CIDR -type f -name "*.conf" | wc -l)
        TOTAL_CIDRS=$(grep -h "route" ASN_CIDR/*.conf | wc -l)
        echo "### ðŸ“¦ æ¦‚è§ˆ" >> README.md
        echo "- **åŒ…å«æ•°æ®çš„ ASN æ€»æ•°ï¼š** ${TOTAL_FILES}" >> README.md
        echo "- **IP CIDR å—æ€»æ•°ï¼š** ${TOTAL_CIDRS}" >> README.md
        echo "" >> README.md
        echo "### ðŸ› ï¸ ASN CIDR è¯¦æƒ…" >> README.md
        echo "" >> README.md
        echo "| ASN | CIDR æ•°é‡ |" >> README.md
        echo "|-----|------------|" >> README.md
        grep -c "route" ASN_CIDR/*.conf | sed -e 's/ASN_CIDR\///' -e 's/.conf:/ /' | sort -k2 -nr | awk '{printf "| %-10s | %-10s |\n", $1, $2}' >> README.md
        echo "" >> README.md
        echo "---" >> README.md
        echo "" >> README.md
        echo "*æ­¤ä¿¡æ¯ç”± GitHub Actions äºŽ ${UPDATE_TIME} è‡ªåŠ¨æ›´æ–°*" >> README.md

    - name: Commit and push changes
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        curr_date=$(date +'%Y-%m-%d %H:%M:%S')
        
        git add ASN_CIDR/ README.md
        
        if git diff --staged --quiet; then
          echo "No changes to commit."
        else
          git commit -m "Auto-update ASN CIDR lists from bgp.he.net - $curr_date"
          git push
        fi
