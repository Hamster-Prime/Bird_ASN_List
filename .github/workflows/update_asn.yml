name: Update ASN CIDR

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-asn:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Fetch CIDRs from bgp.he.net
      run: |
        # 定义需要处理的 ASN 列表
        asns=("AS396856" "AS51894" "AS32590" "AS44907" "AS62014" "AS59930" "AS62041" "AS211157" "AS402075")
        
        # 确保目录存在
        mkdir -p ASN_CIDR
        
        # 循环运行脚本
        for asn in "${asns[@]}"; do
          echo "Processing $asn..."
          # 运行脚本
          if python fetch_asn_cidr_he.py "$asn"; then
             echo "Successfully processed $asn"
          else
             echo "Failed to process $asn"
          fi
          
          # 随机等待
          sleep $((RANDOM % 10 + 5))
        done

    - name: Generate README
      run: python generate_readme.py

    - name: Commit and push changes
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        curr_date=$(date +'%Y-%m-%d %H:%M:%S')
        
        # 添加生成的文件和数据文件
        git add ASN_CIDR/ README.md asn_data.json
        
        if git diff --staged --quiet; then
          echo "No changes to commit."
        else
          git commit -m "Auto-update ASN CIDR lists and README - $curr_date"
          git push
        fi
