name: Update ASN CIDR

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas

    - name: Download and decompress IP list
      run: |
        curl -L "https://ipinfo.io/data/ipinfo_lite.csv.gz?token=${{ secrets.IPINFO_TOKEN }}" -o ipinfo_lite.csv.gz
        gzip -df ipinfo_lite.csv.gz

    - name: Run extraction script
      run: |
        asns=("AS396856" "AS51894" "AS32590" "AS44907" "AS62014" "AS59930" "AS62041" "AS211157")
        mkdir -p ASN_CIDR
        for asn in "${asns[@]}"; do
          echo "Processing $asn..."
          python extract_asn.py "$asn"
        done

    - name: Update README.md
      run: |
        UPDATE_TIME=$(date -u --iso-8601=seconds)
        # å¦‚æžœ README.md ä¸å­˜åœ¨ï¼Œå…ˆåˆ›å»ºå®ƒï¼Œæˆ–è€…ä¿ç•™åŽŸæœ‰çš„å†…å®¹ï¼ˆè¿™é‡Œé‡‡å–è¦†ç›–ç­–ç•¥ä»¥æ¨¡ä»¿å‚è€ƒè„šæœ¬ï¼‰
        > README.md
        echo "# å¸¸ç”¨ ASN CIDR åˆ—è¡¨" >> README.md
        echo "" >> README.md
        echo "**è¯´æ˜Žï¼š** æ­¤æ•°æ®æ¯æ—¥ä»Ž [ipinfo.io](https://ipinfo.io/) è‡ªåŠ¨æ›´æ–°ã€‚" >> README.md
        echo "" >> README.md
        echo "---" >> README.md
        echo "" >> README.md
        echo "## ðŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> README.md
        echo "" >> README.md
        echo "**æœ€åŽæ›´æ–°æ—¶é—´ï¼š** ${UPDATE_TIME}" >> README.md
        echo "" >> README.md
        TOTAL_FILES=$(find ASN_CIDR -type f -name "*.conf" | wc -l)
        TOTAL_CIDRS=$(grep -h "route" ASN_CIDR/*.conf | wc -l)
        echo "### ðŸ“¦ æ¦‚è§ˆ" >> README.md
        echo "- **åŒ…å«æ•°æ®çš„ ASN æ€»æ•°ï¼š** ${TOTAL_FILES}" >> README.md
        echo "- **IP CIDR å—æ€»æ•°ï¼š** ${TOTAL_CIDRS}" >> README.md
        echo "" >> README.md
        echo "### ðŸ› ï¸ ASN CIDR è¯¦æƒ…" >> README.md
        echo "" >> README.md
        echo "| ASN | CIDR æ•°é‡ |" >> README.md
        echo "|-----|------------|" >> README.md
        grep -c "route" ASN_CIDR/*.conf | sed -e 's/ASN_CIDR\///' -e 's/.conf:/ /' | sort -k2 -nr | awk '{printf "| %-10s | %-10s |\n", $1, $2}' >> README.md
        echo "" >> README.md
        echo "---" >> README.md
        echo "" >> README.md
        echo "*æ­¤ä¿¡æ¯ç”± GitHub Actions äºŽ ${UPDATE_TIME} è‡ªåŠ¨æ›´æ–°*" >> README.md

    - name: Commit and push changes
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Automated ASN list update"
        file_pattern: "ASN_CIDR/*.conf README.md"
        commit_user_name: "GitHub Actions"
        commit_user_email: "actions@github.com"
        commit_author: "GitHub Actions <actions@github.com>"
